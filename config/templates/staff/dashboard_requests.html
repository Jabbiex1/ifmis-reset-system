{% extends 'base_staff.html' %}

{% block title %}IFMIS Admin | Requests{% endblock %}

{% block hero %}
<section class="shell hero-wrap">
  <div class="hero-block">
    <h1 class="hero-block__title">Requests Dashboard</h1>
    <p class="hero-block__lead">Review, process, and manage IFMIS password reset requests with fast filtering and safer bulk actions.</p>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="flash-stack" aria-live="polite">
  {% if messages %}
    {% for message in messages %}
      <div class="flash" role="status">{{ message }}</div>
    {% endfor %}
  {% endif %}
</div>

<section class="kpis" aria-label="Request statistics">
  <article class="kpi"><div class="kpi__number" id="sTotal">{{ total_count }}</div><div class="kpi__label">Total Requests</div></article>
  <article class="kpi"><div class="kpi__number" id="sPending">0</div><div class="kpi__label">Pending</div></article>
  <article class="kpi"><div class="kpi__number" id="sDone">0</div><div class="kpi__label">Processed</div></article>
</section>

<section class="panel" style="margin-bottom:12px">
  <div class="toolbar">
    <form method="get" action="/staff/dashboard/" class="filters-grid" aria-label="Filter requests">
      <div>
        <label class="label-small" for="q">Search</label>
        <input id="q" class="control" type="text" name="q" value="{{ search }}" placeholder="Name, department, email, reference">
      </div>
      <div>
        <label class="label-small" for="day">Day</label>
        <input id="day" class="control" type="number" name="day" min="1" max="31" value="{{ day }}">
      </div>
      <div>
        <label class="label-small" for="month">Month</label>
        <select id="month" class="control" name="month">
          <option value="">Any</option>
          <option value="1" {% if month == "1" %}selected{% endif %}>January</option>
          <option value="2" {% if month == "2" %}selected{% endif %}>February</option>
          <option value="3" {% if month == "3" %}selected{% endif %}>March</option>
          <option value="4" {% if month == "4" %}selected{% endif %}>April</option>
          <option value="5" {% if month == "5" %}selected{% endif %}>May</option>
          <option value="6" {% if month == "6" %}selected{% endif %}>June</option>
          <option value="7" {% if month == "7" %}selected{% endif %}>July</option>
          <option value="8" {% if month == "8" %}selected{% endif %}>August</option>
          <option value="9" {% if month == "9" %}selected{% endif %}>September</option>
          <option value="10" {% if month == "10" %}selected{% endif %}>October</option>
          <option value="11" {% if month == "11" %}selected{% endif %}>November</option>
          <option value="12" {% if month == "12" %}selected{% endif %}>December</option>
        </select>
      </div>
      <div>
        <label class="label-small" for="year">Year</label>
        <input id="year" class="control" type="number" name="year" min="2020" max="2099" value="{{ year }}">
      </div>
      <button class="btn btn--primary" type="submit">Apply</button>
    </form>

    {% if search or day or month or year %}
      <div class="filter-meta">Filters active. <a href="/staff/dashboard/">Clear all</a></div>
    {% endif %}
  </div>
</section>

<section class="panel">
  <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--line)">
    <div class="status-tabs" role="tablist" aria-label="Request status views">
      <button class="is-active" type="button" role="tab" aria-selected="true" onclick="filterRows('all',this)">All</button>
      <button type="button" role="tab" aria-selected="false" onclick="filterRows('pending',this)">Pending</button>
      <button type="button" role="tab" aria-selected="false" onclick="filterRows('processed',this)">Processed</button>
    </div>

    <form method="post" action="/staff/bulk-delete/" id="bulkForm" style="margin:0">
      {% csrf_token %}
      <div class="bulk-bar" id="bulkBar" aria-live="polite">
        <strong id="bulkCount">0 selected</strong>
        <button class="btn btn--danger" type="submit" onclick="return confirmBulk()">Delete Selected</button>
        <button class="btn btn--ghost" type="button" onclick="clearSelection()">Cancel</button>
      </div>
    </form>
  </div>

  <div class="table-shell">
    <table class="data-table" id="tbl">
      <thead>
        <tr>
          <th scope="col"><input id="selectAll" type="checkbox" title="Select all visible"></th>
          <th scope="col">#</th>
          <th scope="col">Reference</th>
          <th scope="col">Full Name</th>
          <th scope="col">Department</th>
          <th scope="col">Email</th>
          <th scope="col">Document</th>
          <th scope="col">Submitted</th>
          <th scope="col">Days Open</th>
          <th scope="col">Status</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requests %}
        <tr data-status="{% if req.processed %}processed{% else %}pending{% endif %}">
          <td data-label="Select" class="table-cell-no-label"><input form="bulkForm" class="row-cb" type="checkbox" name="selected_ids" value="{{ req.pk }}"></td>
          <td data-label="Row">{{ page_obj.start_index|add:forloop.counter0 }}</td>
          <td data-label="Reference"><span class="code-pill">{{ req.reference_code }}</span></td>
          <td data-label="Full Name"><strong>{{ req.full_name }}</strong></td>
          <td data-label="Department">{{ req.department }}</td>
          <td data-label="Email">{{ req.email }}</td>
          <td data-label="Document">{% if req.uploaded_file %}<a href="{% url 'serve_uploaded_file' req.uploaded_file.name|cut:'uploads/' %}" target="_blank">View</a>{% else %}-{% endif %}</td>
          <td data-label="Submitted">{{ req.submitted_at|date:"d M Y" }}<br><span class="muted" style="font-size:12px">{{ req.submitted_at|date:"H:i" }}</span></td>
          <td data-label="Days Open">
            {% if req.processed %}
              <span class="badge badge--done">Done</span>
            {% else %}
              {% if req.days_open >= 3 %}<span class="badge" style="background:#fff2f1;border:1px solid #efb6b0;color:var(--danger)">{{ req.days_open }}d</span>
              {% elif req.days_open >= 1 %}<span class="badge badge--pending">{{ req.days_open }}d</span>
              {% else %}<span class="badge badge--done">Today</span>{% endif %}
            {% endif %}
          </td>
          <td data-label="Status">{% if req.processed %}<span class="badge badge--done">Processed</span>{% else %}<span class="badge badge--pending">Pending</span>{% endif %}</td>
          <td data-label="Actions">
            <div class="inline-actions">
              <a href="/staff/request/{{ req.reference_code }}/">View</a>
              {% if not req.processed %}
                <a class="is-process" href="{% url 'process_request' req.pk %}" onclick="return confirm('Mark this request as processed?')">Process</a>
              {% endif %}
              <a class="is-delete" href="{% url 'delete_request' req.pk %}">Delete</a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="11" data-label="Info">No requests found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
  <div class="pagination">
    <div>Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</div>
    <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
      {% if page_obj.has_previous %}
        <a href="?{{ filter_qs }}&page=1">First</a>
        <a href="?{{ filter_qs }}&page={{ page_obj.previous_page_number }}">Prev</a>
      {% else %}
        <span class="is-off">First</span>
        <span class="is-off">Prev</span>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <span class="is-current">{{ num }}</span>
        {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
          <a href="?{{ filter_qs }}&page={{ num }}">{{ num }}</a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="?{{ filter_qs }}&page={{ page_obj.next_page_number }}">Next</a>
        <a href="?{{ filter_qs }}&page={{ page_obj.paginator.num_pages }}">Last</a>
      {% else %}
        <span class="is-off">Next</span>
        <span class="is-off">Last</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
function countStats() {
  const rows = [...document.querySelectorAll('#tbl tbody tr[data-status]')];
  const pending = rows.filter(r => r.dataset.status === 'pending').length;
  const done = rows.filter(r => r.dataset.status === 'processed').length;
  document.getElementById('sPending').textContent = pending;
  document.getElementById('sDone').textContent = done;
}
countStats();

function filterRows(status, btn) {
  document.querySelectorAll('.status-tabs button').forEach(b => {
    b.classList.remove('is-active');
    b.setAttribute('aria-selected', 'false');
  });
  btn.classList.add('is-active');
  btn.setAttribute('aria-selected', 'true');

  document.querySelectorAll('#tbl tbody tr[data-status]').forEach(r => {
    r.style.display = (status === 'all' || r.dataset.status === status) ? '' : 'none';
  });
  clearSelection();
}

const selectAll = document.getElementById('selectAll');
const bulkBar = document.getElementById('bulkBar');
const bulkCount = document.getElementById('bulkCount');

function updateBulk() {
  const checked = [...document.querySelectorAll('.row-cb:checked')];
  bulkBar.classList.toggle('is-visible', checked.length > 0);
  bulkCount.textContent = checked.length + ' selected';

  document.querySelectorAll('#tbl tbody tr').forEach(r => r.classList.remove('is-selected'));
  checked.forEach(cb => cb.closest('tr').classList.add('is-selected'));
}

selectAll.addEventListener('change', () => {
  document.querySelectorAll('.row-cb').forEach(cb => {
    const row = cb.closest('tr');
    if (row.style.display !== 'none') {
      cb.checked = selectAll.checked;
    }
  });
  updateBulk();
});

document.querySelectorAll('.row-cb').forEach(cb => cb.addEventListener('change', updateBulk));

function clearSelection() {
  document.querySelectorAll('.row-cb').forEach(cb => cb.checked = false);
  selectAll.checked = false;
  updateBulk();
}

function confirmBulk() {
  const n = document.querySelectorAll('.row-cb:checked').length;
  if (n === 0) {
    return false;
  }
  return confirm('Delete ' + n + ' selected request(s)?');
}
</script>
{% endblock %}
