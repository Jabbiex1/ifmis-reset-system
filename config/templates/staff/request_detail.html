{% extends 'base_staff.html' %}

{% block title %}IFMIS Admin | Request {{ request_obj.reference_code }}{% endblock %}

{% block hero %}
<section class="shell hero-wrap">
  <div class="hero-block">
    <h1 class="hero-block__title">Request Detail</h1>
    <p class="hero-block__lead">Reference {{ request_obj.reference_code }}. Review request data, documents, and conversation history.</p>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="flash-stack" aria-live="polite">
  {% if messages %}
    {% for message in messages %}
      <div class="flash" role="status">{{ message }}</div>
    {% endfor %}
  {% endif %}
</div>

<div class="action-row" style="margin-bottom:10px">
  <a class="btn btn--ghost" href="/staff/dashboard/">Back to dashboard</a>
  {% if request_obj.processed %}<span class="badge badge--done">Processed</span>{% else %}<span class="badge badge--pending">Pending</span>{% endif %}
</div>

<section class="request-grid">
  <aside>
    <article class="panel section" aria-label="Requestor details" style="margin-bottom:12px">
      <h2 class="section-title" style="font-size:18px">Requestor</h2>
      <div class="card-row"><div class="card-key">Full Name</div><div class="card-value">{{ request_obj.full_name }}</div></div>
      <div class="card-row"><div class="card-key">Department</div><div class="card-value">{{ request_obj.department }}</div></div>
      <div class="card-row"><div class="card-key">Email</div><div class="card-value">{{ request_obj.email }}</div></div>
      <div class="card-row"><div class="card-key">Submitted</div><div class="card-value">{{ request_obj.submitted_at|date:"d M Y, H:i" }}</div></div>
      <div class="card-row"><div class="card-key">Reference</div><div class="card-value"><span class="code-pill">{{ request_obj.reference_code }}</span></div></div>
    </article>

    <article class="panel section" aria-label="Uploaded document" style="margin-bottom:12px">
      <h2 class="section-title" style="font-size:18px">Uploaded Document</h2>
      {% if request_obj.uploaded_file %}
        <div class="action-row">
          <a class="btn btn--ghost" href="{% url 'serve_uploaded_file' request_obj.uploaded_file.name|cut:'uploads/' %}" target="_blank">View document</a>
          <a class="btn btn--ghost" href="{% url 'serve_uploaded_file' request_obj.uploaded_file.name|cut:'uploads/' %}?download=1">Download document</a>
        </div>
      {% else %}
        <p class="muted">No uploaded document.</p>
      {% endif %}
    </article>

    <article class="panel section" aria-label="Request actions">
      <h2 class="section-title" style="font-size:18px">Actions</h2>
      <div class="action-row">
        {% if not request_obj.processed %}
          <form method="post" style="width:100%">
            {% csrf_token %}
            <input type="hidden" name="action" value="mark_processed">
            <button class="btn btn--primary" style="width:100%" type="submit" onclick="return confirm('Mark this request as processed?')">Mark as Processed</button>
          </form>
        {% else %}
          <form method="post" style="width:100%">
            {% csrf_token %}
            <input type="hidden" name="action" value="mark_pending">
            <button class="btn btn--ghost" style="width:100%" type="submit">Revert to Pending</button>
          </form>
        {% endif %}
        <a class="btn btn--danger" style="width:100%" href="{% url 'delete_request' request_obj.pk %}">Delete Request</a>
      </div>
    </article>
  </aside>

  <article class="panel chat-shell" aria-label="Conversation">
    <div class="chat-head">
      <strong>Conversation</strong>
      <span class="muted">{{ chat_messages|length }} message{{ chat_messages|length|pluralize }}</span>
    </div>
    <div class="chat-body" id="chatBox">
      {% for msg in chat_messages %}
        <div class="chat-msg {% if msg.sender == 'admin' %}chat-msg--admin{% else %}chat-msg--user{% endif %}">
          <div class="chat-meta">{% if msg.sender == 'admin' %}You{% else %}{{ request_obj.full_name }}{% endif %} | {{ msg.timestamp|date:"d M, H:i" }}</div>
          <div class="chat-bubble">{{ msg.content }}</div>
        </div>
      {% empty %}
        <div class="chat-empty">No messages yet.</div>
      {% endfor %}
    </div>

    <div class="chat-reply">
      <form method="post" aria-label="Reply to requestor">
        {% csrf_token %}
        <input type="hidden" name="action" value="reply">
        <label for="admin-reply" class="card-key" style="display:block;margin-bottom:6px">Reply</label>
        <textarea id="admin-reply" class="control" name="content" placeholder="Reply to requestor" required></textarea>
        <div class="action-row" style="margin-top:8px;justify-content:flex-end">
          <button class="btn btn--primary" type="submit">Send Reply</button>
        </div>
      </form>
    </div>
  </article>
</section>
{% endblock %}

{% block extra_js %}
<script>
const box = document.getElementById('chatBox');
if (box) {
  box.scrollTop = box.scrollHeight;
}
</script>
{% endblock %}
