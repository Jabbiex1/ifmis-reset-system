{% extends 'base_public.html' %}
{% load static %}

{% block title %}IFMIS Help Desk | Submit Request{% endblock %}

{% block hero %}
<section class="shell hero-wrap">
  <div class="hero-block">
    <h1 class="hero-block__title">IFMIS password reset intake</h1>
    <p class="hero-block__lead">Download the official form, complete it, and submit it with your official details. A reference code is generated immediately for tracking.</p>
  </div>
</section>
{% endblock %}

{% block content %}
{% if reference_code %}
  <section class="panel success-card" aria-labelledby="request-success-title">
    <h2 id="request-success-title" class="section-title">Request submitted</h2>
    <p class="muted">Save this reference code. It is required to track your request.</p>
    <div class="ref-code" aria-live="polite">{{ reference_code }}</div>
    <div class="action-row">
      <a href="/track/?ref={{ reference_code }}" class="btn btn--primary">Track this request</a>
      <a href="/" class="btn btn--ghost">Submit another request</a>
      <button onclick="window.print()" class="btn btn--accent" type="button">Print this page</button>
    </div>
  </section>
{% else %}
  <div class="flash-stack" aria-live="polite">
    {% if rate_limited %}
      <div class="flash flash--error" role="alert">Submission limit reached for this IP address. Please wait 1 hour before retrying.</div>
    {% endif %}
    {% if messages %}
      {% for message in messages %}
        <div class="flash" role="status">{{ message }}</div>
      {% endfor %}
    {% endif %}
  </div>

  <div class="split-grid">
    <section class="panel section" aria-labelledby="submit-request-heading">
      <h2 id="submit-request-heading" class="section-title">Submit request</h2>
      <div class="download-box">
        <div>
          <strong>Official IFMIS reset form</strong>
          <div class="muted">Download, complete, then upload below.</div>
        </div>
        <a class="btn btn--accent" href="{% static 'IFMIS_FORM.pdf' %}" download="IFMIS_Password_Reset_Form.pdf">Download PDF</a>
      </div>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="field">
          <label for="id_full_name">Full Name</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}<div class="field-error" role="alert">{{ form.full_name.errors|join:", " }}</div>{% endif %}
        </div>

        <div class="field">
          <label for="id_department">Department / MDA</label>
          {{ form.department }}
          {% if form.department.errors %}<div class="field-error" role="alert">{{ form.department.errors|join:", " }}</div>{% endif %}
        </div>

        <div class="field">
          <label for="id_email">Official Email</label>
          {{ form.email }}
          <div class="help">Use your official government email.</div>
          {% if form.email.errors %}<div class="field-error" role="alert">{{ form.email.errors|join:", " }}</div>{% endif %}
        </div>

        <div class="field">
          <label for="id_uploaded_file">Completed Form File</label>
          {{ form.uploaded_file }}
          <div class="help">Accepted: PDF, JPG, PNG. Maximum 5MB.</div>
          {% if form.uploaded_file.errors %}<div class="field-error" role="alert">{{ form.uploaded_file.errors|join:", " }}</div>{% endif %}
        </div>

        <div class="action-row">
          <button class="btn btn--primary" type="submit">Submit Request</button>
        </div>
      </form>
    </section>

    <aside class="panel section" aria-label="Help and process">
      <h3 class="section-title" style="font-size:18px">Process</h3>
      <ul class="info-list">
        <li>Download and complete the official form.</li>
        <li>Submit your details and upload the completed file.</li>
        <li>Save the generated reference code.</li>
        <li>Track status and exchange messages on the tracking page.</li>
      </ul>
      <div class="info-box">
        <strong>Support contact</strong><br>
        ifmis.support@mof.gov.sl<br>
        +232 31 399 020
      </div>
      <div class="info-box">
        <strong>Important:</strong> If your reference code is lost, staff cannot recover it from the public portal.
      </div>
    </aside>
  </div>
{% endif %}
{% endblock %}
