{% extends 'base_public.html' %}

{% block title %}IFMIS Help Desk | Track Request{% endblock %}

{% block hero %}
<section class="shell hero-wrap">
  <div class="hero-block">
    <h1 class="hero-block__title">Track your request status</h1>
    <p class="hero-block__lead">Enter your 12-character reference code to view status updates and communicate with the help desk.</p>
  </div>
</section>
{% endblock %}

{% block content %}
<section class="panel section" aria-labelledby="lookup-title">
  <h2 id="lookup-title" class="section-title">Find request</h2>
  <form method="get" action="/track/" class="action-row" aria-label="Reference lookup">
    <div style="flex:1 1 300px">
      <label for="ref">Reference Code</label>
      <input id="ref" class="control" name="ref" type="text" maxlength="12" value="{{ ref_code }}" placeholder="ABC123XYZ789" required autocomplete="off" style="font-family:'IBM Plex Mono',monospace;letter-spacing:.08em;text-transform:uppercase">
    </div>
    <button class="btn btn--primary" type="submit">Find Request</button>
  </form>
  {% if error %}<div class="flash flash--error" role="alert" style="margin-top:12px">{{ error }}</div>{% endif %}
</section>

{% if request_obj %}
<section class="lookup-grid">
  <article class="panel section" aria-label="Request details">
    <div class="card-row">
      <div class="card-key">Status</div>
      <div class="card-value">
        {% if request_obj.processed %}
          <span class="badge badge--done">Processed</span>
        {% else %}
          <span class="badge badge--pending">Pending Review</span>
        {% endif %}
      </div>
    </div>
    <div class="card-row"><div class="card-key">Reference</div><div class="card-value"><span class="code-pill">{{ request_obj.reference_code }}</span></div></div>
    <div class="card-row"><div class="card-key">Full Name</div><div class="card-value">{{ request_obj.full_name }}</div></div>
    <div class="card-row"><div class="card-key">Department</div><div class="card-value">{{ request_obj.department }}</div></div>
    <div class="card-row"><div class="card-key">Submitted</div><div class="card-value">{{ request_obj.submitted_at|date:"d M Y, H:i" }}</div></div>
  </article>

  <article class="panel chat-shell" aria-label="Conversation">
    <div class="chat-head">
      <strong>Conversation</strong>
      <span class="muted">{{ chat_messages|length }} message{{ chat_messages|length|pluralize }}</span>
    </div>

    <div class="chat-body" id="chatBox">
      {% for msg in chat_messages %}
        <div class="chat-msg {% if msg.sender == 'admin' %}chat-msg--admin{% else %}chat-msg--user{% endif %}">
          <div class="chat-meta">{% if msg.sender == 'admin' %}Help Desk{% else %}You{% endif %} | {{ msg.timestamp|date:"d M, H:i" }}</div>
          <div class="chat-bubble">{{ msg.content }}</div>
        </div>
      {% empty %}
        <div class="chat-empty">No messages yet.</div>
      {% endfor %}
    </div>

    {% if request_obj.processed %}
      <div class="done-note">This request is processed. Submit a new request if needed.</div>
    {% else %}
      <div class="chat-reply">
        <form method="post" action="/track/" aria-label="Send message to help desk">
          {% csrf_token %}
          <input type="hidden" name="ref_code" value="{{ request_obj.reference_code }}"/>
          <label for="track-content" class="card-key" style="display:block;margin-bottom:6px">Your Message</label>
          <textarea id="track-content" class="control" name="content" placeholder="Write a message to Help Desk" required></textarea>
          <div class="action-row" style="margin-top:8px;justify-content:flex-end">
            <button class="btn btn--primary" type="submit">Send Message</button>
          </div>
        </form>
      </div>
    {% endif %}
  </article>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const chatBox = document.getElementById('chatBox');
if (chatBox) {
  chatBox.scrollTop = chatBox.scrollHeight;
}

const STORAGE_KEY = 'ifmis_last_ref';
const refInput = document.getElementById('ref');
if (refInput && !refInput.value) {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    refInput.value = saved;
  }
}
const params = new URLSearchParams(window.location.search);
const refFromUrl = params.get('ref');
if (refFromUrl) {
  localStorage.setItem(STORAGE_KEY, refFromUrl.toUpperCase());
}
</script>
{% endblock %}
